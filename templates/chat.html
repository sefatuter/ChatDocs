<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ask anything</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
        --primary: #d73a49;
        --primary-hover: #cb2431;
        --secondary: #2d7dd2;
        --secondary-hover: #3a8ed8;
        --background: #0d1117;
        --surface: #161b22;
        --border: #30363d;
        --text: #c9d1d9;
        --muted: #8b949e;
        --accent: #58a6ff;
        --input-background: #1a1e24; /* Darker background for input, like GitHub Copilot */
        --input-border: #3a3f4b; /* Subtle border for input */
        --send-icon: #58a6ff; /* Blue for send icon, matching GitHub Copilot */
        --send-icon-hover: #79c0ff;
    }
    
    /* Container for the input field and send button */
    .input-container {
        position: relative;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    /* Input field styling */
    input[type="text"] {
        width: 100%;
        padding: 8px 40px 8px 8px; /* Extra padding on the right for the send icon */
        border-radius: 4px;
        background-color: var(--input-background);
        border: 1px solid var(--input-border);
        color: var(--text);
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    input[type="text"]::placeholder {
        color: var(--muted);
    }
    
    input[type="text"]:focus {
        border-color: var(--accent);
        outline: none;
    }
    
    /* Send button styling */
    .send-button {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background-color: transparent;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--send-icon);
        transition: color 0.2s ease;
    }
    
    .send-button:hover {
        color: var(--send-icon-hover);
    }
    
    /* Assuming the ‚ñº icon is an SVG or similar element */
    .send-button svg {
        fill: currentColor;
        width: 16px;
        height: 16px;
    }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        background-color: var(--background);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
        line-height: 1.6;
        padding: 3rem;
      }
      
      h1 {
        color: var(--text);
        font-size: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 600;
      }
      
      .chat-container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        min-height: 0px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-y: auto; /* Enable scrolling for long conversations */
        /*visibility: hidden; /* Initially hidden */
        /*opacity: 0;*/
        transition: visibility 0.2s, opacity 0.2s ease-in-out;
      }
      
      .user-message {
        margin-bottom: 1.5rem;
        font-weight: 500;
        color: var(--text);
      }
      
      .assistant-message {
        background: #21262d;
        padding: 1.25rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        word-wrap: break-word;
      }
      
      .input-group {
        max-width: 1000px;
        margin: 0 auto;
        display: flex; /* Use flexbox to align input and buttons */
        align-items: center; /* Vertically center items */
        gap: 0.5rem; /* Add spacing between input and buttons */
        position: relative; /* For positioning the send icon inside the input */
      }
      .input-container {
        position: relative; /* Allows absolute positioning of the button inside */
        flex-grow: 1; /* Makes the input container take available space */
      }
      
      
      input[type="text"] {
        width: 100%; /* Full width of the container */
        padding: 8px 40px 8px 8px; /* Right padding for button space */
        border-radius: 4px; /* Rounded corners */
        background-color: #2a2a2a; /* Dark background */
        color: #c9d1d9; /* Light text color */
        border: 1px solid #444; /* Subtle border */
      }
      
      input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 5px rgba(88, 166, 255, 0.3);
        outline: none;
      }
      
      .send-icon {
        position: absolute;
        left: 0.75rem; /* Position inside the input field */
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
        border-left: 8px solid var(--send-icon);
        cursor: pointer;
        transition: border-color 0.3s ease;
      }
      
      .send-icon:hover {
        border-left-color: var(--send-icon-hover);
      }
      
      .btn {
        padding: 0.5rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      
      .btn-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      
      .btn-secondary {
        background-color: var(--secondary);
        color: white;
      }
      
      .btn-secondary:hover {
        background-color: var(--secondary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      
      .btn-stop {
        background-color: var(--stop);
        color: white;
        display: none; /* Hidden by default */
      }
      
      .btn-stop:hover {
        background-color: var(--stop-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      
      #loading {
        display: none;
        text-align: center;
        color: var(--accent);
        font-weight: 500;
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
      }

      .send-button, .stop-button {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background-color: transparent;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #c9d1d9;
        transition: background-color 0.2s ease;
        margin-top: 1px;
      }
      
      .send-button:hover, .stop-button:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      
      .send-button svg, .stop-button svg {
        fill: currentColor;
      }
      .title-container {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin-bottom: 2rem;
      }
  
      .title-container svg {
        width: 64px;
        height: 64px;
        transition: transform 0.3s ease;
      }
  
      .title-container:hover svg {
        transform: rotate(10deg) scale(1.1);
      }
  
      .title-container h1 {
        margin: 0;
      }
      /* Loading Overlay Styles */
      .chat-container {
        position: relative; /* Needed so the overlay is positioned relative to the chatbox */
        max-width: 1000px;
        margin: 0 auto;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        min-height: 0px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-y: auto;
        transition: visibility 0.2s, opacity 0.2s ease-in-out;
      }
      
      /* Loading Overlay adjusted for chat container only */
      .loading-overlay {
        position: absolute; /* Positioned within .chat-container */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3); /* Semi-transparent overlay */
        backdrop-filter: blur(2px); /* Optional: adjust blur if needed */
        display: none; /* Show this via JavaScript when needed */
        justify-content: center;
        align-items: center;
        z-index: 10;
      }
      
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--accent);
        border-top: 5px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
  </style>
</head>
<body>
    <div class="title-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="40" height="40">
            <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#336791;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#1C3D59;stop-opacity:1" />
            </linearGradient>
            </defs>
            <rect x="6" y="8" width="20" height="26" fill="white" stroke="#336791" stroke-width="2" rx="3"/>
            <polygon points="6,8 16,8 6,18" fill="#c9d1d9"/>
            <rect x="24" y="28" width="10" height="3" fill="#1C3D59" transform="rotate(45 24 28)"/>
            <circle cx="24" cy="24" r="8" fill="none" stroke="url(#grad1)" stroke-width="2"/>
        </svg>
        <h1>PgDocSearch - Assistant</h1>
    </div>

    <div class="chat-container" id="chat-box">
        <!-- Render previous chat history -->
        {% for msg in chat_history %}
          {% if msg.role == "user" %}
            <div class="user-message">üë§ You: {{ msg.message }}</div>
          {% else %}
            <div class="assistant-message markdown-body">
              <strong>ü§ñ Assistant:</strong> 
              <span class="message-content">{{ msg.message|safe }}</span>
            </div>
          {% endif %}
        {% endfor %}
        
        <!-- Loading Overlay within chat container -->
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
        </div>
      </div>
        
      <div class="input-group">
        <div class="input-container">
          <input type="text" id="question" placeholder="Ask your question...">
          <button class="send-button" title="Send" onclick="askQuestion()">
            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16">
              <path d="M.989 8 .064 2.68a1.342 1.342 0 0 1 1.85-1.462l13.402 5.744a1.13 1.13 0 0 1 0 2.076L1.913 14.782a1.343 1.343 0 0 1-1.85-1.463L.99 8Zm.603-5.288L2.38 7.25h4.87a.75.75 0 0 1 0 1.5H2.38l-.788 4.538L13.929 8Z"></path>
            </svg>
          </button>
          <button class="stop-button" id="stopBtn" title="Stop" onclick="stopRequest()" style="display: none;">
            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16">
              <path d="M4.5 4.5h7v7h-7z"></path>
            </svg>
          </button>
        </div>
        <button class="btn btn-primary" onclick="resetAndGoBack()">üóëÔ∏è Reset</button>
        <button class="btn btn-secondary" onclick="goBack()">üîô Back</button>
      </div>
      
  <script>
    let controller = null;
    let sendButton = document.querySelector(".send-button");

    // Function to render all assistant messages as Markdown
    function renderMarkdown() {
        const assistantMessages = document.querySelectorAll('.assistant-message .message-content');
        assistantMessages.forEach(msg => {
            msg.innerHTML = marked.parse(msg.textContent);
        });
    }

    // Auto-scroll to bottom
    document.addEventListener("DOMContentLoaded", function() {
        setTimeout(() => {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
          });
        }, 100);
      });

    function scrollToBottom() {
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
    });
    }

    function askQuestion() {
      let question = document.getElementById("question").value;
      if (!question.trim()) return;

      let chatBox = document.getElementById("chat-box");
      let loadingIndicator = document.getElementById("loadingOverlay");
      let stopBtn = document.getElementById("stopBtn");

      chatBox.innerHTML += `<div class="user-message">üë§ You: ${question}</div>`;
      document.getElementById("question").value = "";
      loadingIndicator.style.display = "block";
      scrollToBottom();

      loadingOverlay.style.display = "flex";
      // Show stop button
      stopBtn.style.display = "inline-block";
      sendButton.style.display = "none";

      controller = new AbortController();
      const signal = controller.signal;

      fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question }),
        signal: signal
      })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        loadingOverlay.style.display = "none";
        stopBtn.style.display = "none";
        sendButton.style.display = "inline-block";
        if (data.response) {
          chatBox.innerHTML += `<div class="assistant-message markdown-body"><strong>ü§ñ Assistant:</strong> <span>${marked.parse(data.response)}</span></div>`;
          document.getElementById("question").value = "";
          chatBox.scrollTop = chatBox.scrollHeight;
          scrollToBottom();
        }
      })
      .catch(error => {
        loadingOverlay.style.display = "none";;
        stopBtn.style.display = "none";
        sendButton.style.display = "inline-block";
        if (error.name !== 'AbortError') {
          console.error("Error:", error);
          chatBox.innerHTML += `<div class="assistant-message markdown-body"><strong>ü§ñ Assistant:</strong> <span>Error occurred</span></div>`;
        } else {
          chatBox.innerHTML += `<div class="assistant-message markdown-body"><strong>ü§ñ Assistant:</strong> <span>Request stopped</span></div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    function stopRequest() {
        if (controller) {
            controller.abort();
            controller = null;
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("stopBtn").style.display = "none";
            sendButton.style.display = "inline-block";
        }
    }

    function goBack() {
      window.location.href = "/";
    }

    function resetAndGoBack() {
      if (confirm("‚ö†Ô∏è Are you sure you want to reset the database and chat history? This action cannot be undone.")) {
        fetch('/reset_database', { method: 'POST' })
          .then(response => {
            if (!response.ok) throw new Error('Reset failed');
            return response.json();
          })
          .then(data => {
            if (data.status === "success") {
              window.location.href = "/";
            }
          })
          .catch(error => console.error("Error resetting database:", error));
      }
    }

    document.getElementById("question").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        askQuestion();
      }
    });

    const chatInput = document.getElementById("question");
    const chatBox = document.getElementById("chat-box");

    chatInput.addEventListener("input", () => {
        if (chatInput.value.trim() === "" && chatBox.innerHTML.trim() === "") {
            chatBox.style.visibility = "hidden";
            chatBox.style.opacity = "0";
        } else {
            chatBox.style.visibility = "visible";
            chatBox.style.opacity = "1";
        }
      });
  </script>
</body>
</html>